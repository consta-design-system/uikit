import {
  DragNDropFieldExampleChildren,
  DragNDropFieldExampleRenderProps,
  DragNDropFieldExampleEmpty,
} from './examples/DragNDropFieldExampleChildren/DragNDropFieldExampleChildren';
import {
  DragNDropFieldExampleMultiple,
  DragNDropFieldExampleSingle,
} from './examples/DragNDropFieldExampleMultiple/DragNDropFieldExampleMultiple';
import {
  DragNDropFieldExampleAcceptImage,
  DragNDropFieldExampleAcceptDoc,
  DragNDropFieldExampleAccept,
} from './examples/DragNDropFieldExampleAccept/DragNDropFieldExampleAccept';
import { DragNDropFieldExampleMaxSize } from './examples/DragNDropFieldExampleMaxSize/DragNDropFieldExampleMaxSize';
import {
  DragNDropFieldExampleOnDropAccepted,
  DragNDropFieldExampleOnDropAcceptedWithInformer,
} from './examples/DragNDropFieldExampleOnDropAccepted/DragNDropFieldExampleOnDropAccepted';

import {
  DragNDropFieldExampleCallbackOnDrop,
  DragNDropFieldExampleCallbackOthers,
} from './examples/DragNDropFieldExampleCallback/DragNDropFieldExampleCallback';

import { DragNDropFieldExampleWithInformer } from './examples/DragNDropFieldExampleWithInformer/DragNDropFieldExampleWithInformer';
import { DragNDropFieldExampleErrorMessages } from './examples/DragNDropFieldExampleErrorMessages/DragNDropFieldExampleErrorMessages';
import { DragNDropFieldExampleInformer } from './examples/DragNDropFieldExampleInformer/DragNDropFieldExampleInformer';
import { MdxMenu, MdxTabs, MdxInformer, Example } from '@consta/stand';

<MdxMenu>

- [Обзор](#обзор)
- [Импорт](#импорт)
- [Свойства](#свойства)
- [Содержимое](#содержимое)
  - [Дочерние элементы](#дочерние-элементы)
  - [Тип файлов](#тип-файлов)
  - [Размер файла](#размер-файла)
  - [Несколько файлов](#несколько-файлов)
- [Локализация](#локализация)
  - [Основные свойства](#основные-свойства)
  - [Тексты ошибок](#тексты-ошибок)
  - [Единицы измерения](#единицы-измерения)
- [Обработка событий](#обработка-событий)
  - [onDrop](#ondrop)
  - [onDropAccepted](#ondropaccepted)
  - [onDropRejected](#ondroprejected)
  - [onError](#onerror)
- [Генерация сообщений об ошибках](#генерация-сообщений-об-ошибках)
- [Информер](#информер)
- [Пример использования](#пример-использования)

</MdxMenu>

<MdxInformer status="warning">

Чтобы использовать компонент, обновите библиотеку [react-dropzone](https://react-dropzone.js.org/?ref=blog.horizon-ui.com) до версии `^14.2.3`.

</MdxInformer>

## Обзор

`DragNDropField` позволяет загружать файлы перетаскиванием в область компонента или через диалоговое окно. Компонент поддерживает настройку типов файлов, ограничения по размеру, множественную загрузку, локализацию и обработку событий.

## Импорт

```tsx
import {
  DragNDropField,
  DragNDropFieldInformer,
} from '@consta/uikit/DragNDropFieldCanary';
```

## Свойства

| Свойство                             | Тип                                                                                                                                                                                                                                                                 | По умолчанию | Описание                                                         |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ | ---------------------------------------------------------------- |
| [`children?`](#дочерние-элементы)    | `React.ReactNode` &#124; `(props: { openFileDialog: () => void, isFocused: boolean, isDragActive: boolean, isDragAccept: boolean, isDragReject: boolean, isFileDialogActive: boolean, acceptedFiles: File[], fileRejections: FileRejection[] }) => React.ReactNode` | —            | Дочерние элементы или рендер-функция.                            |
| [`accept?`](#тип-файлов)             | `Accept`                                                                                                                                                                                                                                                            | —            | Допустимые типы файлов (MIME-типы и расширения).                 |
| [`maxSize?`](#размер-файла)          | `number`                                                                                                                                                                                                                                                            | —            | Максимальный размер файла (в байтах).                            |
| [`minSize?`](#размер-файла)          | `number`                                                                                                                                                                                                                                                            | —            | Минимальный размер файла (в байтах).                             |
| [`multiple?`](#несколько-файлов)     | `boolean`                                                                                                                                                                                                                                                           | `false`      | Разрешить загрузку нескольких файлов.                            |
| [`maxFiles?`](#несколько-файлов)     | `number`                                                                                                                                                                                                                                                            | —            | Максимальное количество файлов для загрузки за раз.              |
| [`locale?`](#локализация)            | `DragNDropFieldPropLocale`                                                                                                                                                                                                                                          | —            | Настройки локализации (тексты ошибок, единицы измерения и т.д.). |
| [`onDrop?`](#ondrop)                 | `(acceptedFiles: File[], fileRejections: FileRejection[], event: DropEvent) => void`                                                                                                                                                                                | —            | Обработчик события дропа.                                        |
| [`onDropAccepted?`](#ondropaccepted) | `(files: File[]) => void`                                                                                                                                                                                                                                           | —            | Обработчик принятых файлов.                                      |
| [`onDropRejected?`](#ondroprejected) | `(fileRejections: FileRejection[], event: DropEvent) => void`                                                                                                                                                                                                       | —            | Обработчик отклоненных файлов.                                   |
| [`onError?`](#onerror)               | `(err: Error) => void`                                                                                                                                                                                                                                              | —            | Обработчик других ошибок.                                        |
| `disabled?`                          | `boolean`                                                                                                                                                                                                                                                           | —            | Отключение компонента.                                           |
| `className?`                         | `string`                                                                                                                                                                                                                                                            | —            | Дополнительные CSS-классы.                                       |
| `ref?`                               | `React.Ref<HTMLDivElement>`                                                                                                                                                                                                                                         | —            | Ссылка на корневой DOM-элемент.                                  |

## Содержимое

### Дочерние элементы

Свойство `children` определяет содержимое области загрузки. Оно принимает `React.ReactNode` или рендер-функцию, которая предоставляет доступ к состоянию компонента и методу `openFileDialog` для открытия диалогового окна.

Пример с `React.ReactNode`:

<MdxTabs>

<DragNDropFieldExampleChildren />

```tsx
<DragNDropField>
  <Text>Перетащите сюда файлы</Text>
</DragNDropField>
```

</MdxTabs>

Пример с рендер-функцией:

<MdxTabs>

<DragNDropFieldExampleRenderProps />

```tsx
<DragNDropField>
  {({ openFileDialog }) => (
    <>
      <Text>Перетащите сюда файлы или загрузите по кнопке</Text>
      <br />
      <Button onClick={openFileDialog} label="Выбрать файл" />
    </>
  )}
</DragNDropField>
```

</MdxTabs>

### Тип файлов

Свойство `accept` ограничивает типы файлов, указывая MIME-типы и расширения. Формат: объект, где ключи — MIME-типы, а значения — массивы расширений.

<MdxInformer status="normal">

Типы MIME могут различаться на разных платформах. Например, CSV на macOS — `text/plain`, а на Windows — `application/vnd.ms-excel`. В некоторых случаях MIME-тип может быть не определен.

</MdxInformer>

Пример:

<MdxTabs>

<DragNDropFieldExampleAccept />

```tsx
<DragNDropField
  accept={{
    'image/png': ['.png'],
    'image/jpeg': ['.jpeg', '.jpg'],
    'image/gif': ['.gif'],
  }}
/>
```

</MdxTabs>

### Размер файла

Свойства `maxSize` и `minSize` задают ограничения на размер файла в байтах.

Пример с ограничением максимального размера:

<MdxTabs>

<DragNDropFieldExampleMaxSize />

```tsx
<DragNDropField maxSize={1 * 1024 * 1024}>
  <Text>Сюда можно перетащить файлы размером 1 Мб или меньше</Text>
</DragNDropField>
```

</MdxTabs>

## Несколько файлов

Свойство `multiple` (по умолчанию `false`) позволяет загружать несколько файлов. Свойство `maxFiles` ограничивает количество файлов, загружаемых за раз.

Пример множественной загрузки:

<MdxTabs>

<DragNDropFieldExampleMultiple />

```tsx
<DragNDropField multiple>
  <Text>Сюда можно перетащить много файлов</Text>
</DragNDropField>
```

</MdxTabs>

## Локализация

Свойство `locale` типа `DragNDropFieldPropLocale` позволяет настроить тексты компонента, включая ошибки, подписи и единицы измерения.

### Основные свойства

| Свойство              | Тип                           | По умолчанию                                                                               | Описание                                              |
| --------------------- | ----------------------------- | ------------------------------------------------------------------------------------------ | ----------------------------------------------------- |
| `call-to-action`      | `string` &#124; `LocaleLabel` | `Перетащите файл сюда или загрузите по кнопке`                                             | Основной текст в области компонента.                  |
| `action-button`       | `string` &#124; `LocaleLabel` | `Выбрать файл`                                                                             | Текст кнопки выбора файла.                            |
| `drag-active-message` | `string`                      | `Перетащите файлы сюда`                                                                    | Текст при перетаскивании (`isDragActive=true`).       |
| `file`                | `string`                      | `файл`                                                                                     | Текст для единственного файла (при `multiple=false`). |
| `files`               | `string`                      | `файлы`                                                                                    | Текст для множественных файлов (при `multiple=true`). |
| `fit-files`           | `string`                      | `Подходят файлы {from + размер + единица измерения + before + размер + единица измерения}` | Текст ограничений по размеру.                         |
| `from`                | `string`                      | `от`                                                                                       | Используется в `fit-files` для минимального размера.  |
| `before`              | `string`                      | `до`                                                                                       | Используется в `fit-files` для максимального размера. |

### Тексты ошибок

| Свойство            | Тип      | По умолчанию                                                                 | Описание                                                    |
| ------------------- | -------- | ---------------------------------------------------------------------------- | ----------------------------------------------------------- |
| `file-invalid-type` | `string` | `{имя файла}: формат файла не подходит ({тип файла})`                        | Ошибка неподходящего формата.                               |
| `file-too-large`    | `string` | `{имя файла}: файл слишком большой (максимум {размер + единица измерения})`  | Ошибка при превышении `maxSize`.                            |
| `file-too-small`    | `string` | `{имя файла}: файл слишком маленький (минимум {размер + единица измерения})` | Ошибка при размере меньше `minSize`.                        |
| `too-many-files`    | `string` | `Вы перетащили несколько файлов. Выберите один, пожалуйста`                  | Ошибка при загрузке нескольких файлов при `multiple=false`. |
| `general-error`     | `string` | `{имя файла}: не получилось добавить файл`                                   | Общая ошибка загрузки.                                      |

### Единицы измерения

| Свойство   | Тип      | По умолчанию |
| ---------- | -------- | ------------ |
| `gigabyte` | `string` | `Гб`         |
| `megabyte` | `string` | `Мб`         |
| `kilobyte` | `string` | `Кб`         |
| `byte`     | `string` | `байт`       |

## Обработка событий

Компонент поддерживает четыре обработчика событий: `onDrop`, `onDropAccepted`, `onDropRejected` и `onError`.

### onDrop

Вызывается при любом событии дропа, независимо от принятия или отклонения файлов.

```tsx
type onDrop = (
  acceptedFiles: File[],
  fileRejections: FileRejection[],
  event: DropEvent,
) => void;
```

<MdxInformer status="normal">

Вызывается всегда, даже если файлы не приняты.

</MdxInformer>

### onDropAccepted

Вызывается, если хотя бы один файл соответствует условиям (`accept`, `maxSize`, `minSize`, `multiple`).

```tsx
type onDropAccepted = (files: File[]) => void;
```

### onDropRejected

Вызывается, если хотя бы один файл отклонен.

```tsx
type onDropRejected = (
  fileRejections: FileRejection[],
  event: DropEvent,
) => void;
```

### onError

Обработчик ошибок, не связанных с отклонением файлов.

```tsx
type onError = (err: Error) => void;
```

Пример обработки событий:

<MdxTabs>

<DragNDropFieldExampleCallbackOnDrop />

```tsx
<DragNDropField
  accept={{ 'application/msword': ['.doc', '.docx'] }}
  multiple
  onDrop={(filesAccepted, filesRejected) => {
    console.log(filesAccepted);
    console.log(filesRejected);
    alert(
      `Файлов принято: ${filesAccepted.length}. Файлов отвергнуто: ${filesRejected.length}`,
    );
  }}
  onDropAccepted={(filesAccepted) => {
    console.log(filesAccepted);
    alert(`Файлов принято: ${filesAccepted.length}.`);
  }}
  onDropRejected={(filesRejected) => {
    console.log(filesRejected);
    alert(`Файлов отвергнуто: ${filesRejected.length}.`);
  }}
  onError={(error) => {
    console.log(error);
    alert(`Ошибка! ${error.message}`);
  }}
/>
```

</MdxTabs>

## Генерация сообщений об ошибках

Для генерации сообщений об ошибках используйте метод `getErrorsList`, который принимает `FileRejection[]`, а также опционально `locale` и `sizes`. Возвращает массив строк с ошибками.

Пример:

<MdxTabs>

<DragNDropFieldExampleErrorMessages />

```tsx
const customLocale: DragNDropFieldPropLocale = {
  'file-too-large': ({ file }) => `Ой! Похоже ${file.name} слишком большой`,
};
return (
  <DragNDropField
    maxSize={10}
    onDropAccepted={(files) => console.log(files)}
    onDropRejected={(reject) => {
      console.log(reject);
      alert(getErrorsList(reject, customLocale, { maxSize: 10 }).join('; '));
    }}
  />
);
```

</MdxTabs>

## Информер

Компонент `DragNDropFieldInformer` отображает статус загрузки, ошибки или другие сообщения.

| Свойство         | Тип                                 | По умолчанию | Описание                                                            |
| ---------------- | ----------------------------------- | ------------ | ------------------------------------------------------------------- |
| `status?`        | `'default'`, `'alert'`, `'warning'` | `'default'`  | Статус информера.                                                   |
| `icon?`          | `IconComponent`                     | —            | Иконка слева.                                                       |
| `loading?`       | `boolean` &#124; `number`           | `false`      | Индикатор загрузки (число — процент, `true` — бесконечный спиннер). |
| `text?`          | `string`                            | —            | Текст сообщения.                                                    |
| `withButton?`    | `boolean`                           | `false`      | Наличие кнопки справа.                                              |
| `buttonIcon?`    | `IconComponent`                     | —            | Иконка на кнопке.                                                   |
| `buttonLabel?`   | `string—                            | —            | Текст всплывающей подсказки кнопки.                                 |
| `onButtonClick?` | `() => void`                        | —            | Обработчик клика по кнопке.                                         |

Пример:

<MdxTabs>

<DragNDropFieldExampleInformer />

```tsx
<DragNDropFieldInformer status="default" text="Ничего не происходит" />

<DragNDropFieldInformer
  status="default"
  icon={IconCancel}
  text={isLoading ? 'Загрузка...' : 'Загрузка остановлена'}
  loading={isLoading}
  withButton
  buttonIcon={isLoading ? IconClose : IconRevert}
  buttonLabel={isLoading ? 'Стоп' : 'Заново'}
  onButtonClick={() => setIsLoading(!isLoading)}
/>

<DragNDropFieldInformer
  status="alert"
  icon={IconAlert}
  text="Что-то пошло не так"
/>

<DragNDropFieldInformer
  status="warning"
  icon="IconAlert"
  text="Есть проблемы, есть на кнопку, чтобы узнать подробнее"
  withButton
  buttonIcon={IconInfo}
  buttonLabel="Подробнее"
  onButtonClick={() => alert('Здесь список ошибок')}
/>
```

</MdxTabs>

Пример интеграции `DragNDropField` с `DragNDropFieldInformer`:

<MdxTabs>

<DragNDropFieldExampleWithInformer />

```tsx
const [filesDropped, setFilesDropped] = useState<File[]>([]);
const [warningMessages, setMessages] = useState<FileRejection[]>([]);
const [otherError, errorSetOtherError] = useState<Error>();

const handleDrop = (acceptedFiles: droppedFile[], rejections): void => {
  setFilesDropped([...filesDropped, ...acceptedFiles]);
  setMessages(rejections);
};

let status: DragNDropFieldInformerStatus = 'default';
if (otherError) {
  status = 'alert';
} else {
  status = warningMessages.length > 0 ? 'warning' : 'default';
}

let text: string;
switch (status) {
  case 'default':
    text = `Картинок загружено: ${filesDropped.length}`;
    break;
  case 'alert':
    text = 'Что-то пошло не так';
    break;

  case 'warning':
    text = getErrors(warningMessages).join('; ');
    break;
}

return (
  <>
    <div className={cnDragNDropFieldExampleWithInformer('DropContainer')}>
      {filesDropped.map((fileDropped, index) => (
        <img
          src={URL.createObjectURL(fileDroppedfileDropped)}
          alt={fileDropped.name}
          title={droppedFileDropped.name}
          key={index}
          className={cnDragNDropFieldExampleWithInformer('DroppedItem', [
            cnDragNDropFieldExampleWithInformer('DroppedImage'),
          ])}
        />
      ))}
      <DragNDropField
        multiple={filesDropped}
        accept={{DroppedFiles 'image/*': []}}
        onError={setOtherError}
        onDrop={handleDrop}
        className={cnDragNDropFieldExampleWithInformer('DroppedItem')}
        title="Upload any images here"
      >
        <IconAdd />
      </DragNDropField>
    </div>
    <DragNDropFieldInformer
      status={status}
      icon={status !== 'default' ? IconAlert : IconPhoto}
      text={text}
      withButton={true}
      buttonLabel="Retry"
      buttonIcon={IconRevert}
      onButtonClick={() => {
        setFilesDropped([]));
        errorSetOtherError(undefined);
        setMessages([])([]);
      }}
    />
  </>
);
```

</MdxTabs>

## Пример использования

Базовый пример использования компонента:

```tsx
<DragNDropField
  multiple
  accept={{ 'image/*': [] }}
  maxSize={5 * 1024 * 1024}
  onDropAccepted={(files) => console.log('Принятые файлы:', files)}
  onDropRejected={(rejections) => console.log('Отклоненные файлы:', rejections)}
>
  <Text>Перетащите сюда изображения до 5 Мб</Text>
</DragNDropField>
```
