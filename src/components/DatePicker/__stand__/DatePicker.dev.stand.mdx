import { MdxMenu, MdxInformer, MdxTabs } from '@consta/stand';

import { DatePickerExampleValue } from './examples/DatePickerExampleValue/DatePickerExampleValue';
import { DatePickerExampleOnError } from './examples/DatePickerExampleOnError/DatePickerExampleOnError';
import { DatePickerExampleFormat } from './examples/DatePickerExampleFormat/DatePickerExampleFormat';
import { DatePickerExampleAdditionalControls } from './examples/DatePickerExampleAdditionalControls/DatePickerExampleAdditionalControls';
import { DatePickerExampleStatus } from './examples/DatePickerExampleStatus/DatePickerExampleStatus';
import {
  DatePickerExampleLabel,
  DatePickerExampleLabelIcon,
} from './examples/DatePickerExampleLabel/DatePickerExampleLabel';
import { DatePickerExampleRequired } from './examples/DatePickerExampleRequired/DatePickerExampleRequired';
import { DatePickerExampleCaption } from './examples/DatePickerExampleCaption/DatePickerExampleCaption';
import {
  DatePickerExampleTypeDate,
  DatePickerExampleTypeDateRange,
  DatePickerExampleTypeDateTime,
  DatePickerExampleTypeDateTimeRange,
  DatePickerExampleTypeTime,
  DatePickerExampleTypeYear,
  DatePickerExampleTypeYearRange,
  DatePickerExampleTypeMonth,
  DatePickerExampleTypeMonthRange,
} from './examples/DatePickerExampleType/DatePickerExampleType';
import { DatePickerExampleMulti } from './examples/DatePickerExampleMulti/DatePickerExampleMulti';
import { DatePickerExampleDropdownOpen } from './examples/DatePickerExampleDropdownOpen/DatePickerExampleDropdownOpen';
import { DatePickerExampleTwoIcons } from './examples/DatePickerExampleTwoFields/DatePickerExampleTwoFields';
import { DatePickerExampleDisableDates } from './examples/DatePickerExampleDisableDates/DatePickerExampleDisableDates';
import { DatePickerExampleWithClearButton } from './examples/DatePickerExampleWithClearButton/DatePickerExampleWithClearButton';

<MdxMenu>

- [Обзор](#обзор)
- [Импорт](#импорт)
- [Свойства](#свойства)
- [Содержимое](#содержимое)
  - [Выбор даты](#выбор-даты)
  - [Тип календаря](#тип-календаря)
  - [Формат даты](#формат-даты)
  - [Интервал времени](#интервал-времени)
- [Внешний вид](#внешний-вид)
  - [Лейбл](#лейбл)
  - [Подпись](#подпись)
  - [Статус](#статус)
  - [Размер и форма](#размер-и-форма)
  - [Иконки и текст в полях](#иконки-и-текст-в-полях)
  - [Кнопка очистки](#кнопка-очистки)
- [Поведение](#поведение)
  - [Обязательность](#обязательность)
  - [Дополнительные контролы](#дополнительные-контролы)
  - [Отключение интервалов](#отключение-интервалов)
  - [Управление выпадающим списком](#управление-выпадающим-списком)
  - [Обработка ошибок](#обработка-ошибок)
- [Пример использования](#пример-использования)

</MdxMenu>

## Обзор

`DatePicker` позволяет пользователю выбирать дату, время или период с помощью поля ввода и выпадающего календаря. Компонент поддерживает настройку формата, ограничения выбора, добавление дополнительных элементов управления и обработку ошибок.

## Импорт

```tsx
import { DatePicker } from '@consta/uikit/DatePicker';
```

## Свойства

| Свойство                                                     | Тип                                                                                                                                                                                       | По умолчанию          | Описание                                                   |
| ------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------- | ---------------------------------------------------------- |
| [`value?`](#выбор-даты)                                      | `DatePickerPropValue<TYPE>`                                                                                                                                                               | -                     | Выбранная дата или период                                  |
| [`onChange?`](#выбор-даты)                                   | `DatePickerPropOnChange<TYPE>`                                                                                                                                                            | -                     | Событие выбора даты или периода                            |
| [`type?`](#тип-календаря)                                    | `'date' \| 'date-range' \| 'date-time' \| 'date-time-range' \| 'time' \| 'month' \| 'month-range' \| 'year' \| 'year-range'`                                                              | `date`                | Тип календаря: выбор даты, времени или периода             |
| [`format?`](#формат-даты)                                    | `string`                                                                                                                                                                                  | `'dd.MM.yyyy'`        | Формат отображения даты                                    |
| [`separator?`](#формат-даты)                                 | `string`                                                                                                                                                                                  | `'.'`                 | Разделитель в формате даты                                 |
| [`label?`](#лейбл)                                           | `string`                                                                                                                                                                                  | -                     | Лейбл к полю ввода                                         |
| [`labelIcon?`](#лейбл)                                       | `IconComponent`                                                                                                                                                                           | -                     | Иконка слева от лейбла                                     |
| [`labelPosition?`](#лейбл)                                   | `'top' \| 'left'`                                                                                                                                                                         | `'top'`               | Положение лейбла относительно поля                         |
| [`caption?`](#подпись)                                       | `string`                                                                                                                                                                                  | -                     | Подпись под полем ввода                                    |
| [`status?`](#статус)                                         | `'alert' \| 'success' \| 'warning'`                                                                                                                                                       | -                     | Статус поля                                                |
| [`size?`](#размер-и-форма)                                   | `'m' \| 'xs' \| 's' \| 'l'`                                                                                                                                                               | `'m'`                 | Размер поля                                                |
| [`form?`](#размер-и-форма)                                   | `'default' \| 'brick' \| 'round' \| 'clearRound' \| 'roundClear' \| 'clearDefault' \| 'defaultClear' \| 'defaultBrick' \| 'brickDefault' \| 'brickClear' \| 'clearBrick' \| 'clearClear'` | `'default'`           | Форма поля                                                 |
| [`view?`](#размер-и-форма)                                   | `'default' \| 'clear'`                                                                                                                                                                    | `'default'`           | Внешний вид поля                                           |
| [`leftSide?`](#иконки-и-текст-в-полях)                       | `DatePickerPropSide<TYPE>`                                                                                                                                                                | -                     | Иконка или текст слева внутри поля                         |
| [`rightSide?`](#иконки-и-текст-в-полях)                      | `DatePickerPropSide<TYPE>`                                                                                                                                                                | -                     | Иконка или текст справа внутри поля                        |
| [`withClearButton?`](#кнопка-очистки)                        | `boolean`                                                                                                                                                                                 | -                     | Добавляет кнопку для очистки поля                          |
| [`required?`](#обязательность)                               | `boolean`                                                                                                                                                                                 | -                     | Обязательность поля                                        |
| [`renderAdditionalControls?`](#дополнительные-контролы)      | `DateTimeAdditionalControlRenderProp`                                                                                                                                                     | -                     | Дополнительные контролы для календаря                      |
| [`disableDates?`](#отключение-интервалов)                    | `Array<Date \| [Date, Date]>`                                                                                                                                                             | -                     | Отключенные даты или интервалы                             |
| [`dropdownOpen?`](#управление-выпадающим-списком)            | `boolean`                                                                                                                                                                                 | -                     | Состояние выпадающего списка (открыт/закрыт)               |
| [`onDropdownOpen?`](#управление-выпадающим-списком)          | `(open: boolean) => void`                                                                                                                                                                 | -                     | Событие при открытии/закрытии выпадающего списка           |
| [`ignoreOutsideClicksRefs?`](#управление-выпадающим-списком) | `ReadonlyArray<React.RefObject<HTMLElement>>`                                                                                                                                             | -                     | Ссылки на элементы, игнорируемые при кликах вне компонента |
| [`onError?`](#обработка-ошибок)                              | `DatePickerPropOnError`                                                                                                                                                                   | -                     | Обработка ошибок ввода                                     |
| [`multiplicityHours?`](#интервал-времени)                    | `number`                                                                                                                                                                                  | `1`                   | Интервал для вывода часов                                  |
| [`multiplicityMinutes?`](#интервал-времени)                  | `number`                                                                                                                                                                                  | `1`                   | Интервал для вывода минут                                  |
| [`multiplicitySeconds?`](#интервал-времени)                  | `number`                                                                                                                                                                                  | `1`                   | Интервал для вывода секунд                                 |
| `name?`                                                      | `DatePickerPropName<TYPE>`                                                                                                                                                                | -                     | Имя поля ввода                                             |
| `minDate?`                                                   | `Date`                                                                                                                                                                                    | `01.01.0001 00:00:00` | Минимальная дата для выбора                                |
| `maxDate?`                                                   | `Date`                                                                                                                                                                                    | `31.12.9999 23:59:59` | Максимальная дата для выбора                               |
| `events?`                                                    | `Date[]`                                                                                                                                                                                  | -                     | События на календаре                                       |
| `dateTimeView?`                                              | `'classic' \| 'book' \| 'slider'`                                                                                                                                                         | `'classic'`           | Вид календаря                                              |
| `locale?`                                                    | `Locale`                                                                                                                                                                                  | `ruLocale`            | Локализация календаря                                      |
| `currentVisibleDate?`                                        | `Date`                                                                                                                                                                                    | `new Date()`          | Текущая отображаемая дата                                  |
| `onChangeCurrentVisibleDate?`                                | `(date: Date) => void`                                                                                                                                                                    | -                     | Событие при изменении отображаемой даты                    |
| `disabled?`                                                  | `boolean`                                                                                                                                                                                 | -                     | Отключение ввода                                           |
| `onFocus?`                                                   | `DatePickerPropOnFocus<TYPE>`                                                                                                                                                             | -                     | Событие при фокусе                                         |
| `onBlur?`                                                    | `DatePickerPropOnFocus<TYPE>`                                                                                                                                                             | -                     | Событие при потере фокуса                                  |
| `autoFocus?`                                                 | `boolean`                                                                                                                                                                                 | -                     | Автофокус на поле                                          |
| `placeholder?`                                               | `DatePickerPropPlaceholder<TYPE>`                                                                                                                                                         | `'ДД.ММ.ГГГГ'`        | Подсказка в поле                                           |
| `inputRef?`                                                  | `DatePickerPropInputRef<TYPE>`                                                                                                                                                            | -                     | Ссылка на DOM-элемент поля ввода                           |
| `dropdownForm?`                                              | `'default' \| 'brick' \| 'round'`                                                                                                                                                         | `'default'`           | Форма выпадающего календаря                                |
| `dropdownClassName?`                                         | `string`                                                                                                                                                                                  | -                     | CSS-класс для выпадающего блока                            |
| `className?`                                                 | `string`                                                                                                                                                                                  | -                     | CSS-класс для компонента                                   |
| `ref?`                                                       | `React.Ref<HTMLDivElement>`                                                                                                                                                               | -                     | Ссылка на корневой DOM-элемент                             |

```tsx
import { Locale } from 'date-fns';
import ruLocale from 'date-fns/locale/ru';

type Range = 'date-range' | 'date-time-range' | 'year-range' | 'month-range';

type DatePickerPropValue<TYPE> =
  | (TYPE extends 'date' ? Date : [Date?, Date?])
  | null;

type DatePickerPropInputRef<TYPE> = TYPE extends Range
  ? [React.Ref<HTMLInputElement>?, React.Ref<HTMLInputElement>?]
  : React.Ref<HTMLInputElement>;

type DatePickerPropSide<TYPE> = TYPE extends Range
  ?
      | [(string | IconComponent)?, (string | IconComponent)?]
      | string
      | IconComponent
  : string | IconComponent;

type DatePickerPropOnFocus<TYPE> = TYPE extends Range
  ?
      | [
          React.FocusEventHandler<HTMLElement>?,
          React.FocusEventHandler<HTMLElement>?,
        ]
      | React.FocusEventHandler<HTMLElement>
  : React.FocusEventHandler<HTMLElement>;

type DatePickerPropName<TYPE> = TYPE extends Range
  ? [string?, string?] | string
  : string;

export type DatePickerPropPlaceholder<TYPE> = TYPE extends Range
  ? [string?, string?] | string
  : string;

type DatePickerPropOnChange<TYPE> = (
  value: DatePickerPropValue<TYPE>,
  props: {
    e: React.MouseEvent<HTMLButtonElement, MouseEvent> | Event;
  },
) => void;

type DatePickerPropOnError = (
  props:
    | {
        type: 'outOfRange';
        stringValue: string;
        dd?: string;
        MM?: string;
        yyyy?: string;
        date: Date;
      }
    | {
        type: 'invalidInputAttempt';
        stringValue: string;
        dd?: string;
        MM?: string;
        yyyy?: string;
      }
    | {
        type: 'startDateIsGreaterThanEndDate';
        date: DateRange;
      },
) => void;
```

## Содержимое

### Выбор даты

Свойства `value` и `onChange` управляют выбранной датой или периодом. `value` принимает дату (`Date`) для одиночного выбора или массив дат (`[Date?, Date?]`) для периода. `onChange` вызывается при изменении значения.

<MdxTabs>

<DatePickerExampleValue />

```tsx
const [value, setValue] = useState<Date | null>(null);
return <DatePicker value={value} onChange={setValue} />;
```

</MdxTabs>

### Тип календаря

Свойство `type` определяет режим выбора:

- `date` — одна дата.
- `date-range` — период дат.
- `date-time` — дата и время.
- `date-time-range` — период с временем.
- `time` — только время.
- `month` — месяц.
- `month-range` — период месяцев.
- `year` — год.
- `year-range` — период годов.

<MdxTabs>

<DatePickerExampleTypeDate />

```tsx
const [value, setValue] = useState<Date | null>(null);
return <DatePicker type="date" value={value} onChange={setValue} />;
```

</MdxTabs>

<MdxTabs>

<DatePickerExampleTypeDateRange />

```tsx
const [value, setValue] = useState<[Date?, Date?] | null>(null);
return <DatePicker type="date-range" value={value} onChange={setValue} />;
```

</MdxTabs>

### Формат даты

Свойства `format` и `separator` задают формат отображения даты. По умолчанию `format="dd.MM.yyyy"`, `separator="."`. Для американского формата используйте `format="MM/dd/yyyy"`, `separator="/"`.

<MdxInformer status="warning">
  Если тип требует ввода даты с точностью до дня, указывайте формат с точностью
  до дня. Для месяца и года — только месяц и год.
</MdxInformer>

<MdxInformer status="normal">
  Время всегда указывается после даты в формате.
</MdxInformer>

<MdxTabs>

<DatePickerExampleFormat />

```tsx
const [value, setValue] = useState<Date | null>(null);
return (
  <DatePicker
    type="date-time"
    format="MM/dd/yyyy HH:mm"
    separator="/"
    placeholder="ММ/ДД/ГГГГ ЧЧ:ММ"
    value={value}
    onChange={setValue}
  />
);
```

</MdxTabs>

### Интервал времени

Для режимов с временем (`date-time`, `date-time-range`) свойства `multiplicityHours`, `multiplicityMinutes` и `multiplicitySeconds` задают интервалы выбора. По умолчанию — 1 (все значения). Укажите 0, чтобы скрыть единицу, или, например, 15 для минут, чтобы показывать только четверти часа.

<MdxTabs>

<DatePickerExampleMulti />

</MdxTabs>

## Внешний вид

### Лейбл

Свойства `label`, `labelPosition` и `labelIcon` добавляют текстовую метку и иконку. `labelPosition` может быть `top` или `left`.

<MdxTabs>

<DatePickerExampleLabel />

```tsx
<DatePicker label="Лейбл" labelPosition="top" />
<DatePicker label="Лейбл" labelPosition="left" />
```

</MdxTabs>

<MdxTabs>

<DatePickerExampleLabelIcon />

```tsx
<DatePicker label="Лейбл" labelIcon={IconQuestion} />
```

</MdxTabs>

### Подпись

Свойство `caption` добавляет подпись под полем, которая наследует стиль от `status`.

<MdxTabs>

<DatePickerExampleCaption />

```tsx
<DatePicker status="success" caption="Успешно" />
<DatePicker status="alert" caption="Ошибка" />
<DatePicker status="warning" caption="Предупреждение" />
<DatePicker caption="Обычная подпись" />
```

</MdxTabs>

### Статус

Свойство `status` (`success`, `alert`, `warning`) выделяет поле цветом, указывая на его состояние.

<MdxTabs>

<DatePickerExampleStatus />

```tsx
<DatePicker status="success" />
<DatePicker status="alert" />
<DatePicker status="warning" />
<DatePicker />
```

</MdxTabs>

### Размер и форма

Свойства `size`, `form` и `view` настраивают внешний вид поля:

- `size`: `xs`, `s`, `m`, `l`.
- `form`: `default`, `brick`, `round`, `clearRound`, и другие комбинации.
- `view`: `default`, `clear`.

### Иконки и текст в полях

Свойства `leftSide` и `rightSide` добавляют иконки или текст внутри полей. Для типов с двумя полями (`date-range` и др.) можно указать массив значений: `[значение_для_левого_поля, значение_для_правого_поля]`.

<MdxTabs>

<DatePickerExampleTwoIcons />

```tsx
const [value, setValue] = useState<[Date?, Date?] | null>(null);
return (
  <DatePicker
    type="date-range"
    value={value}
    onChange={setValue}
    leftSide={[IconForward, IconBackward]}
    rightSide={['туда', 'обратно']}
    placeholder={['Начало', 'Конец']}
  />
);
```

</MdxTabs>

### Кнопка очистки

Свойство `withClearButton` добавляет крестик для очистки поля, который появляется при наличии значения.

<MdxTabs>

<DatePickerExampleWithClearButton />

```tsx
const [value, setValue] = useState<Date | null>(null);
return <DatePicker value={value} onChange={setValue} withClearButton />;
```

</MdxTabs>

## Поведение

### Обязательность

Свойство `required` делает поле обязательным, добавляя маркер к лейблу.

<MdxTabs>

<DatePickerExampleRequired />

```tsx
<DatePicker label="Обязательное" required />
<DatePicker label="Необязательное" />
```

</MdxTabs>

### Дополнительные контролы

Свойство `renderAdditionalControls` позволяет добавить кастомные элементы управления в календарь, например, кнопку для выбора текущего квартала.

<MdxTabs>

<DatePickerExampleAdditionalControls />

```tsx
const [value, setValue] = useState<DatePickerPropValue<'date-range'>>([
  undefined,
  undefined,
]);
const setQuarter = (date: Date) => {
  const year = date.getFullYear();
  const month = date.getMonth();
  if (month >= 0 && month < 3) {
    setValue([new Date(year, 0, 1), new Date(year, 3, 0)]);
  } else if (month >= 3 && month < 6) {
    setValue([new Date(year, 3, 1), new Date(year, 6, 0)]);
  } else if (month >= 6 && month < 9) {
    setValue([new Date(year, 6, 1), new Date(year, 9, 0)]);
  } else {
    setValue([new Date(year, 9, 1), new Date(year + 1, 0, 0)]);
  }
};
return (
  <DatePicker
    value={value}
    type="date-range"
    onChange={setValue}
    renderAdditionalControls={({ currentVisibleDate }) => (
      <Button
        label="Этот квартал"
        onClick={() => currentVisibleDate && setQuarter(currentVisibleDate)}
      />
    )}
  />
);
```

</MdxTabs>

### Отключение интервалов

Свойство `disableDates` позволяет запретить выбор определённых дат или интервалов, передавая массив дат или пар дат.

<MdxTabs>

<DatePickerExampleDisableDates />

```tsx
const getDisableDates = (): Array<Date | [Date, Date]> => {
  const date = new Date();
  const year = date.getFullYear();
  const month = date.getMonth();
  const day = date.getDate();
  return [
    [
      new Date(year, month, day, 12, 34, 20),
      new Date(year, month, day, 16, 10, 41),
    ],
    new Date(year, month, day + 1),
    [new Date(year, month, 1), new Date(year, month, 13)],
  ];
};
const disableDates = getDisableDates();
const [value, setValue] = useState<Date | null>();
return (
  <DatePicker
    type="date-time"
    value={value}
    disableDates={disableDates}
    onChange={setValue}
  />
);
```

</MdxTabs>

### Управление выпадающим списком

Свойства `dropdownOpen`, `onDropdownOpen` и `ignoreOutsideClicksRefs` управляют состоянием выпадающего календаря:

- `dropdownOpen` - флаг открыт/закрыт,
- `onDropdownOpen` - колбэк отрабатывающий каждый раз при открытии/закрытии,
- `ignoreOutsideClicksRefs` - список ссылок на элементы по которым игнорируются клики.

<MdxTabs>

<DatePickerExampleDropdownOpen />

```tsx
const Icon = withAnimateSwitcherHOC({
  startIcon: IconArrowDown,
  startDirection: 0,
  endDirection: 180,
});
const [value, setValue] = useState<Item | null>();
const [open, setOpen] = useFlag();
const buttonRef = useRef<HTMLButtonElement>(null);
const inputRef = useRef<HTMLInputElement>(null);
const onDropdownOpen = useCallback((open: boolean) => {
  setOpen.set(open);
  if (open) {
    inputRef.current?.focus();
  }
}, []);
return (
  <AnimateIconSwitcherProvider active={open}>
    <FieldGroup>
      <Button
        ref={buttonRef}
        label={open ? 'Закрыть' : 'Открыть'}
        onClick={setOpen.toggle}
        iconLeft={Icon}
        onlyIcon
      />
      <DatePicker
        inputRef={inputRef}
        placeholder="Выберите вариант"
        value={value}
        onChange={setValue}
        dropdownOpen={open}
        onDropdownOpen={onDropdownOpen}
        ignoreOutsideClicksRefs={[buttonRef]}
      />
    </FieldGroup>
  </AnimateIconSwitcherProvider>
);
```

</MdxTabs>

### Обработка ошибок

Свойство `onError` позволяет отслеживать ошибки ввода:

- `outOfRange` — дата, которую вводит пользователь, не попадает в диапазон между `minDate` и `maxDate`.
- `invalidInputAttempt` — пользователь вводит несуществующую дату.
- `startDateIsGreaterThanEndDate` — дата начала больше, чем дата конца периода.

<MdxTabs>

<DatePickerExampleOnError />

```tsx
const minDate = new Date(2000, 1, 1);
const maxDate = new Date(2001, 1, 1);
const formatDate = (date: Date) => format(date, 'dd.MM.yyyy');
const ref = useRef<HTMLDivElement>(null);
const [value, setValue] = useState<[Date?, Date?] | null>(null);
const [error, setError] = useState<string | undefined>();
const onChange: DatePickerPropOnChange<'date-range'> = (value) => {
  setValue(value);
  setError(undefined);
};
const onError: DatePickerPropOnError = (props) => {
  if (props.type === 'outOfRange') {
    setError(
      `Дата ${formatDate(props.date)} не входит в диапазон c ${formatDate(
        minDate,
      )} по ${formatDate(maxDate)}`,
    );
  }
  if (props.type === 'invalidInputAttempt') {
    setError(`Даты ${props.stringValue} не существует`);
  }
  if (props.type === 'startDateIsGreaterThanEndDate') {
    setError(
      `Дата начала (${formatDate(
        props.date[0],
      )}) больше, чем дата конца (${formatDate(props.date[1])})`,
    );
  }
};
return (
  <>
    <DatePicker
      minDate={minDate}
      maxDate={maxDate}
      ref={ref}
      status={error ? 'alert' : undefined}
      value={value}
      onChange={onChange}
      type="date-range"
      onError={onError}
    />
    <Tooltip isOpen={!!error} status="alert" anchorRef={ref}>
      {error}
    </Tooltip>
  </>
);
```

</MdxTabs>

## Пример использования

```tsx
const [value, setValue] = useState<Date | null>(null);
return (
  <DatePicker
    type="date"
    value={value}
    onChange={setValue}
    label="Выберите дату"
    labelPosition="top"
    withClearButton
  />
);
```
