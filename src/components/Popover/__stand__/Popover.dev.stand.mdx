import { MdxMenu, MdxTabs } from '@consta/stand';
import {
  PopoverPositionedByCoordsExample,
  PopoverPositionedByAnchorExample,

} from './examples/PopoverExample/PopoverExample';

import { PopoverViewportExample } from './examples/PopoverViewportExample/PopoverViewportExample';

<MdxMenu>

- [Обзор](#обзор)
- [Импорт](#импорт)
- [Свойства](#свойства)
- [Содержимое](#содержимое)
- [Способы позиционирования](#способы-позиционирования)
  - [Элемент-якорь](#элемент-якорь)
  - [Координаты](#координаты)
- [Внешний вид](#внешний-вид)
  - [Направление разворачивания](#направление-разворачивания)
  - [Отступы](#отступы)
- [Viewport](#viewport)
- [Пример использования](#пример-использования)

</MdxMenu>

## Обзор

Компонент `Popover`предназначен для отображения всплывающего окна, которое может быть привязано к элементу-якорю или к координатам на экране. Он позволяет гибко настраивать содержимое, направление разворачивания, отступы и поведение при взаимодействии с пользователем. Подходит для создания тултипов, контекстных меню и других всплывающих элементов.

## Импорт

```tsx
import { Popover } from '@consta/uikit/Popover';
```

## Свойства

| Свойство                                             | Тип или варианты значения                                            | По умолчанию            | Описание                                                                                                     |
| ---------------------------------------------------- | -------------------------------------------------------------------- | ----------------------- | ------------------------------------------------------------------------------------------------------------ |
| [`children`](#содержимое)                            | `React.ReactNode` &#124; `(direction: Direction) => React.ReactNode` | -                       | Контент поповера                                                                                             |
| [`anchorRef?`](#элемент-якорь)                       | `React.RefObject<HTMLElement>`                                       | -                       | Элемент, относительно которого будет позиционироваться поповер (обязателен, если не указано `position`)      |
| [`position?`](#координаты)                           | `{ x: number; y: number }` &#124; `undefined`                        | -                       | Координаты точки, к которой прикрепляется поповер (обязательны, если не заполнено `anchorRef`)               |
| [`direction?`](#направление-разворачивания)          | `Direction`                                                          | `'upCenter'`            | Основное направление для разворачивания поповера                                                             |
| [`possibleDirections?`](#направление-разворачивания) | `Direction[]`                                                        | Все возможные Direction | Дополнительные направления, в которые может разворачиваться поповер                                          |
| [`spareDirection?`](#направление-разворачивания)     | `Direction`                                                          | `'downStartLeft'`       | Дополнительное направление, в которое развернется поповер, если не найдется ни одного возможного направления |
| [`offset?`](#отступы)                                | `PopoverPropOffset`                                                  | `0`                     | Отступ от якоря или позиции                                                                                  |
| [`arrowOffset?`](#отступы)                           | `number`                                                             | -                       | Сдвиг в нецентральных позициях (используется для центровки стрелочки у тултипа)                              |
| [`viewportRef?`](#viewport)                          | `React.RefObject<HTMLElement>`                                       | -                       | Ссылка на вьюпорт                                                                                            |
| `equalAnchorWidth`                                   | `boolean`                                                            | -                       | Ширина поповера равна ширине элемента, указанного в `anchorRef`                                              |
| `isInteractive?`                                     | `boolean`                                                            | `true`                  | Можно ли взаимодействовать с содержимым поповера                                                             |
| `onClickOutside?`                                    | `(event: MouseEvent) => void`                                        | -                       | Действие по клику за пределами поповера и его якоря (если есть)                                              |
| `container?`                                         | `Element`                                                            | `window.document.body`  | Родительский контейнер для поповера                                                                          |
| `className?`                                         | `string`                                                             | -                       | Дополнительный CSS-класс для стилизации                                                                      |
| `as?`                                                | `string`                                                             | -                       | HTML-тег для рендеринга компонента                                                                           |
| `ref?`                                               | `React.RefObject<HTMLElement>`                                       | -                       | Ссылка на DOM-элемент компонента                                                                             |

```tsx
type PopoverPropOffset =
  | '3xs'
  | '2xs'
  | 'xs'
  | 's'
  | 'm'
  | 'l'
  | 'xl'
  | '2xl'
  | '3xl'
  | '4xl'
  | '5xl'
  | '6xl'
  | number;

type Direction =
  | 'downCenter'
  | 'upCenter'
  | 'downRight'
  | 'downLeft'
  | 'upRight'
  | 'upLeft'
  | 'leftUp'
  | 'leftCenter'
  | 'leftDown'
  | 'rightUp'
  | 'rightCenter'
  | 'rightDown'
  | 'downStartLeft'
  | 'upStartLeft'
  | 'downStartRight'
  | 'upStartRight'
  | 'leftStartUp'
  | 'leftStartDown'
  | 'rightStartUp'
  | 'rightStartDown';
```

## Содержимое

Свойство `children` определяет содержимое поповера. В него можно передать:

- Обычные элементы React (`React.ReactNode`), такие как текст, изображения или другие компоненты.
- Функцию-RenderProp вида `(direction: Direction) => React.ReactNode`, которая позволяет изменять содержимое в зависимости от направления разворачивания поповера. Это полезно, например, для настройки отображения стрелочки тултипа в зависимости от направления.

## Способы позиционирования

### Элемент-якорь

Поповер можно прикрепить к HTML-элементу (например, к кнопке) с помощью свойства `anchorRef`. Это свойство принимает ссылку на элемент (`React.RefObject<HTMLElement>`), относительно которого позиционируется поповер.

<MdxTabs>

<PopoverPositionedByAnchorExample />

```tsx
const anchorRef = useRef<HTMLButtonElement>(null);
const [isPopoverVisible, setIsPopoverVisible] = useState(false);

const handleClickOnAnchor = () => {
  setIsPopoverVisible(!isPopoverVisible);
};

return (
  <>
    <div>
      <Button
        label="Нажмите меня"
        type="button"
        onClick={handleClickOnAnchor}
        ref={anchorRef}
      />
    </div>
    {isPopoverVisible && (
      <Popover
        direction="upCenter"
        spareDirection="downStartLeft"
        offset="2xs"
        arrowOffset={0}
        onClickOutside={action('onClickOutside')}
        isInteractive={true}
        anchorRef={anchorRef}
        equalAnchorWidth={false}
      >
        <div>
          <Text view="primary" size="xs">
            Это содержимое поповера: здесь может быть что угодно, например, этот
            текст.
          </Text>
        </div>
      </Popover>
    )}
  </>
);
```

</MdxTabs>

### Координаты

Поповер можно прикрепить к определенной точке на экране, задав координаты через свойство `position` (тип `{ x: number; y: number }`). Координаты указываются относительно окна браузера (вьюпорта). Для динамического обновления позиции рекомендуется использовать хук `usePopoverReposition`, который отслеживает прокрутку и изменение размеров окна.

<MdxTabs>

<PopoverPositionedByCoordsExample />

```tsx
const [position, setPosition] = useState<Position>(undefined);

const handleMouseMove = (event: React.MouseEvent) => {
  setPosition({ x: event.clientX, y: event.clientY });
};

return (
  <>
    <div
      onMouseMove={handleMouseMove}
      onMouseLeave={() => setPosition(undefined)}
    >
      <Text view="primary" size="m">
        Область, в которой работает отслеживание мышки
      </Text>
    </div>
    <Popover
      direction="upCenter"
      spareDirection="downStartLeft"
      offset="2xs"
      arrowOffset={0}
      onClickOutside={action('onClickOutside')}
      isInteractive={false}
      position={position}
    >
      {(direction) => (
        <div>
          <Text view="primary" size="xs">
            Это содержимое поповера: здесь может быть что угодно, например, этот
            текст.
          </Text>
          <Text view="primary" size="xs">
            Направление: {direction}
          </Text>
        </div>
      )}
    </Popover>
  </>
);
```

</MdxTabs>

## Внешний вид

### Направление разворачивания

Направление разворачивания поповера задается свойством `direction`. Если в указанном направлении недостаточно места, поповер автоматически выберет одно из направлений, указанных в `possibleDirections`. Если ни одно из них не подходит, используется направление из `spareDirection` (по умолчанию `'downStartLeft'`).

Порядок выбора направления:

1. Проверяется значение свойства `direction`.
2. Если места недостаточно, перебираются направления из `possibleDirections` в порядке их указания.
3. Если ни одно направление не подходит, используется `spareDirection`.

### Отступы

- **offset**: задает отступ поповера от элемента-якоря или координат. Может быть числом (в пикселях) или одним из предопределенных значений (`'3xs'`, `'2xs'`, `'xs'`, `'s'`, `'m'`, `'l'`, `'xl'`, `'2xl'`, `'3xl'`, `'4xl'`, `'5xl'`, `'6xl'`). По умолчанию `0`.
- **arrowOffset**: задает сдвиг стрелки тултипа в нецентральных позициях для корректного отображения. Указывается в пикселях.

## Viewport

По умолчанию вьюпортом для поповера является `document.documentElement`. Чтобы задать другой элемент в качестве вьюпорта, используйте свойство `viewportRef`. Это полезно, если поповер должен быть ограничен областью с прокруткой, чтобы не выходить за её пределы.

<MdxTabs>

<PopoverViewportExample />

```tsx
const refs = useRefs<HTMLDivElement>(items.length + 1);

return (
  <>
    <div
      ref={refs[0]}
      className={cnPopoverViewportExample(null, cnMixScrollBar())}
    >
      <Grid cols={cols} className={cnPopoverViewportExample('Wrapper')}>
        {items.map((item, index) => (
          <GridItem
            className={cnPopoverViewportExample('Item', [
              cnMixFlex({
                flex: 'flex',
                align: 'center',
                justify: 'center',
              }),
            ])}
          >
            <Badge
              ref={anchorRefs[index + 1]}
              label={item.toString()}
              form="round"
            />
          </GridItem>
        ))}
      </Grid>
    </div>
    {items.map((item, index) => (
      <Popover
        direction="upCenter"
        possibleDirections={[
          'upCenter',
          'downCenter',
          'rightCenter',
          'leftCenter',
        ]}
        spareDirection="upCenter"
        offset="m"
        isInteractive={false}
        viewportRef={refs[0]}
        anchorRef={anchorRefs[index + 1]}
      >
        <div className={cnPopoverViewportExample('PopoverContent')}>
          <Text size="xs" view="primary" lineHeight="m">
            для {item}
          </Text>
        </div>
      </Popover>
    ))}
  </>
);
```

```css
.PopoverViewportExample {
  height: 400px;
  overflow: auto;

  &-Wrapper {
    height: 600px;
    width: 100%;
    &.Grid[class*='Grid_cols_'] {
      grid-template-columns: repeat(var(--grid-cols, 1), auto);
    }
  }

  &-Item {
    min-width: 200px;
    min-height: 160px;
  }

  &-Popover {
    --popover-pointer-events: none;
  }

  &-PopoverContent {
    padding: var(--space-s);
    background: var(--color-bg-default);
    border: 1px solid var(--color-bg-border);
    box-shadow: var(--shadow-modal);
  }
}
```

</MdxTabs>
